<!DOCTYPE html>
<html lang="ko" class="light">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>EPUB Editor v1.2.0</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Inter+Tight:wght@400;500;600&display=swap');

  :root {
    --bg: #f4f5f7;
    --bg2: #ffffff;
    --bg3: #eceef2;
    --bg-hover: #e2e5eb;
    --border: #d1d5df;
    --text: #3a3f52;
    --text-dim: #7b8299;
    --text-bright: #1e2130;
    --accent: #5a4fd4;
    --accent2: #5eead4;
    --accent-dim: rgba(90,79,212,0.1);
    --red: #dc2626;
    --green: #16a34a;
    --yellow: #d97706;
    --font-ui: 'Inter Tight', 'Malgun Gothic', sans-serif;
    --font-code: 'JetBrains Mono', monospace;
  }

  :root.dark {
    --bg: #0e0f11;
    --bg2: #161820;
    --bg3: #1e2130;
    --bg-hover: #252838;
    --border: #2a2e3d;
    --text: #c8ccd8;
    --text-dim: #5a5f72;
    --text-bright: #eef0f5;
    --accent: #7c6aff;
    --accent-dim: rgba(124,106,255,0.15);
    --red: #f87171;
    --green: #4ade80;
    --yellow: #fbbf24;
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: var(--font-ui);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow: auto;
    user-select: none;
  }

  /* ‚îÄ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ‚îÄ */
  .topbar {
    display: flex;
    align-items: center;
    gap: 12px;
    height: 48px;
    padding: 0 16px;
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .topbar .logo {
    font-weight: 600;
    font-size: 15px;
    color: var(--accent);
    letter-spacing: 0.5px;
  }
  .topbar .spacer { flex:1; }
  .topbar button {
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--font-ui);
    font-size: 12px;
    font-weight: 500;
    padding: 6px 14px;
    border-radius: 6px;
    cursor: pointer;
    transition: all .15s;
  }
  .topbar button:hover { background: var(--bg-hover); border-color: var(--accent); color: var(--text-bright); }
  .topbar button.primary { background: #ffd9df; border-color: #ffd9df; color: #4c4143; }
  .topbar button.primary:hover { background: #ff8b9a; }
  .topbar button.open-btn { background: #c4c1ef; border-color: #c4c1ef; color: white; }
  .topbar button.open-btn:hover { background: #7c6aff; }
  .topbar button.reset-btn { background: #b3deeb; border-color: #b3deeb; color: white; }
  .topbar button.reset-btn:hover { background: #69a4b7; }
  .topbar button:disabled { opacity: .35; cursor: default; }
  .topbar .fname {
    font-size: 12px;
    color: var(--text-dim);
    max-width: 500px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .theme-toggle {
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--text);
    font-size: 16px;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all .15s;
  }
  .theme-toggle:hover { background: var(--bg-hover); border-color: var(--accent); }

  /* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
  .layout {
    display: flex;
    height: calc(100dvh - 48px - 28px);
    overflow: hidden;
  }

  /* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
  .sidebar {
    width: 380px;
    min-width: 380px;
    background: var(--bg2);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .sidebar-header {
    padding: 10px 14px;
    font-size: 10px;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 1.2px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }
  .sidebar-header .controls {
    display: flex;
    gap: 4px;
    align-items: center;
    margin-left: auto;
  }
  .sort-btn, .action-btn {
    cursor: pointer;
    color: var(--text-dim);
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 4px;
    transition: all .15s;
    background: transparent;
    border: 1px solid transparent;
    font-family: var(--font-ui);
    font-weight: 600;
  }
  .sort-btn:hover, .action-btn:hover { 
    background: var(--bg3); 
    border-color: var(--border);
    color: var(--text);
  }
  .sort-btn.active { 
    background: var(--accent-dim);
    border-color: var(--accent);
    color: var(--accent);
  }
  .action-btn.toc-btn { background: #fff3bd; color: #2d3436; border-color: #ffda64; }
  .action-btn.toc-btn:hover { background: #ffeaa7; border-color: #f39c12; }
  .action-btn.search-btn { background: #c2f1d6; color: #2c2c2c; border-color: #83d5a6; }
  .action-btn.search-btn:hover { background: #7ae1a5; border-color: #7ae1a5; }

  .file-tree {
    flex: 1;
    overflow-y: auto;
    padding: 6px 0;
  }
  .file-group-label {
    padding: 8px 14px 4px;
    font-size: 9px;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 1px;
    cursor: pointer;
  }
  .file-group-label:hover { color: var(--text); }
  .file-group { margin-bottom: 4px; }
  .file-group.collapsed .file-group-items { display: none; }
  .file-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 14px;
    font-size: 11px;
    color: var(--text);
    cursor: pointer;
    transition: background .12s;
    white-space: nowrap;
    overflow: hidden;
  }
  .file-item:hover { background: var(--bg-hover); }
  .file-item.active {
    background: var(--accent-dim);
    color: var(--accent);
  }
  .file-item .icon {
    font-size: 13px;
    width: 16px;
    text-align: center;
    flex-shrink: 0;
  }
  .file-item .file-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 0;
  }
  .file-item .timestamp {
    font-size: 9px;
    color: var(--text-dim);
    font-family: var(--font-code);
    flex-shrink: 0;
  }
  .file-item.active .timestamp { color: var(--accent); }
  .file-item.modified { color: var(--red); }
  .file-item .spine-num {
    font-size: 9px;
    background: var(--accent-dim);
    color: var(--accent);
    padding: 1px 4px;
    border-radius: 3px;
    margin-right: 4px;
  }

  /* ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Editor tabs */
  .editor-tabs {
    display: flex;
    align-items: center;
    gap: 2px;
    padding: 6px 10px 0;
    background: var(--bg);
    flex-shrink: 0;
    overflow-x: auto;
  }
  .tab {
    padding: 6px 12px;
    font-size: 11px;
    color: var(--text-dim);
    border-radius: 6px 6px 0 0;
    cursor: pointer;
    background: transparent;
    border: none;
    font-family: var(--font-ui);
    transition: all .12s;
    white-space: nowrap;
    max-width: 160px;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .tab:hover { color: var(--text); background: var(--bg3); }
  .tab.active {
    background: var(--bg2);
    color: var(--text-bright);
    border: 1px solid var(--border);
    border-bottom: 1px solid var(--bg2);
    margin-bottom: -1px;
  }
  .tab.modified::before { content: "‚óè"; color: var(--yellow); margin-right: 4px; }
  .tab .close {
    opacity: .4;
    cursor: pointer;
    font-size: 14px;
  }
  .tab .close:hover { opacity: 1; color: var(--red); }

  /* Editor area */
  .editor-wrap {
    flex: 1;
    display: flex;
    flex-direction: column;
    border-top: 1px solid var(--border);
    overflow: hidden;
    background: var(--bg2);
  }

  /* Code editor */
  .code-editor {
    flex: 1;
    width: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-code);
    font-size: 13px;
    line-height: 1.7;
    padding: 16px 20px;
    resize: none;
    border: none;
    outline: none;
    overflow: auto;
    tab-size: 2;
  }
  .code-editor::selection { background: rgba(124,106,255,0.25); }

  /* TOC editor special */
  .toc-editor {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: var(--bg);
  }
  .toc-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid transparent;
    transition: all .12s;
    cursor: grab;
    margin-bottom: 4px;
  }
  .toc-item:hover { border-color: var(--border); background: var(--bg3); }
  .toc-item.dragging { opacity: .4; }
  .toc-item .drag-handle { color: var(--text-dim); font-size: 14px; cursor: grab; }
  .toc-item input.toc-label {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--text-bright);
    font-family: var(--font-ui);
    font-size: 13px;
    outline: none;
  }
  .toc-item input.toc-label:focus { border-bottom: 1px solid var(--accent); }
  .toc-item .toc-target {
    font-size: 10px;
    color: var(--text-dim);
    font-family: var(--font-code);
    background: var(--bg2);
    padding: 2px 8px;
    border-radius: 4px;
    max-width: 140px;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .toc-item button {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 14px;
    padding: 2px 6px;
    border-radius: 4px;
  }
  .toc-item button:hover { background: var(--bg3); color: var(--red); }
  .toc-actions {
    display: flex;
    gap: 8px;
    padding: 12px 20px;
    border-top: 1px solid var(--border);
    background: var(--bg2);
    flex-shrink: 0;
  }
  .toc-actions button {
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--font-ui);
    font-size: 11px;
    padding: 5px 12px;
    border-radius: 5px;
    cursor: pointer;
  }
  .toc-actions button:hover { border-color: var(--accent); color: var(--accent); }

  /* Image preview */
  .img-preview-wrap {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: var(--bg);
    gap: 16px;
    padding: 20px;
    overflow: auto;
  }
  .img-preview-wrap img { max-width: 100%; max-height: 60vh; border-radius: 8px; border: 1px solid var(--border); }
  .img-meta { font-size: 11px; color: var(--text-dim); font-family: var(--font-code); }
  .img-actions { display: flex; gap: 8px; }
  .img-actions button {
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--font-ui);
    font-size: 11px;
    padding: 5px 12px;
    border-radius: 5px;
    cursor: pointer;
  }
  .img-actions button:hover { border-color: var(--accent); color: var(--accent); }

  /* Empty state */
  .empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    color: var(--text-dim);
  }
  .empty-state .big-icon { font-size: 48px; opacity: .3; }
  .empty-state p { font-size: 13px; }

  /* Status bar */
  .statusbar {
    height: 28px;
    padding: 0 14px;
    background: var(--bg2);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 20px;
    font-size: 10px;
    color: var(--text-dim);
    flex-shrink: 0;
  }
  .statusbar .modified { color: var(--yellow); }

  /* Drop overlay */
  .drop-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(14,15,17,.85);
    z-index: 100;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 12px;
  }
  .drop-overlay.show { display: flex; }
  .drop-overlay .drop-box {
    border: 2px dashed var(--accent);
    border-radius: 16px;
    padding: 60px 80px;
    text-align: center;
  }
  .drop-overlay .drop-box p { font-size: 18px; color: var(--accent); font-weight: 500; }
  .drop-overlay .drop-box .sub { font-size: 12px; color: var(--text-dim); margin-top: 6px; }

  /* Modal */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 200;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.show { display: flex; }
  .modal {
    background: var(--bg2);
    border-radius: 12px;
    border: 1px solid var(--border);
    width: 90%;
    max-width: 800px;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 25px 50px rgba(0,0,0,0.25);
  }
  .modal-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .modal-header h3 { font-size: 15px; font-weight: 600; color: var(--text-bright); }
  .modal-header .close-btn {
    background: none;
    border: none;
    font-size: 20px;
    color: var(--text-dim);
    cursor: pointer;
  }
  .modal-header .close-btn:hover { color: var(--red); }
  .modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
  }
  .modal-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }
  .modal-footer button {
    padding: 8px 20px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid var(--border);
    background: var(--bg3);
    color: var(--text);
  }
  .modal-footer button:hover { border-color: var(--accent); }
  .modal-footer button.primary {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }
  .modal-footer button.primary:hover { opacity: 0.9; }

  /* Search modal */
  .search-input-wrap {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }
  .search-input-wrap input {
    flex: 1;
    padding: 10px 14px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--bg);
    color: var(--text);
    font-size: 13px;
    outline: none;
  }
  .search-input-wrap input:focus { border-color: var(--accent); }
  .search-options {
    display: flex;
    gap: 16px;
    margin-bottom: 15px;
  }
  .search-options label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    cursor: pointer;
  }
  .search-results {
    border: 1px solid var(--border);
    border-radius: 6px;
    max-height: 350px;
    overflow-y: auto;
    background: var(--bg);
  }
  .search-result-item {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    font-size: 12px;
  }
  .search-result-item:hover { background: var(--bg-hover); }
  .search-result-item:last-child { border-bottom: none; }
  .search-result-item .file-header {
    color: var(--accent);
    font-weight: 600;
    padding: 4px 0;
  }
  .search-result-item .line-info { color: var(--text-dim); }

  /* TOC Dialog styles */
  .toc-section {
    margin-bottom: 20px;
  }
  .toc-section-header {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-bright);
    margin-bottom: 10px;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
  }
  .toc-btn-row {
    display: flex;
    gap: 8px;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }
  .toc-btn-row button {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid var(--border);
    background: var(--bg3);
    color: var(--text);
  }
  .toc-btn-row button:hover { border-color: var(--accent); color: var(--accent); }
  .toc-btn-row button.success { background: #e8f5e9; color: #2e7d32; border-color: #81c784; }
  .toc-btn-row button.success:hover { background: #c8e6c9; }
  .toc-tree {
    border: 1px solid var(--border);
    border-radius: 6px;
    max-height: 200px;
    overflow-y: auto;
    background: var(--bg);
    margin-bottom: 15px;
  }
  .toc-tree-item {
    padding: 6px 12px;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .toc-tree-item:last-child { border-bottom: none; }
  .toc-tree-item.level-1 { background: #fff8dc; }
  .toc-tree-item.level-2 { background: #fffaf0; padding-left: 24px; }
  .toc-tree-item.level-3 { background: #ffffff; padding-left: 36px; }
  .new-toc-list {
    border: 1px solid var(--border);
    border-radius: 6px;
    max-height: 300px;
    overflow-y: auto;
    background: var(--bg);
  }
  .new-toc-item {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: grab;
    transition: background .1s;
  }
  .new-toc-item:hover { background: var(--bg-hover); }
  .new-toc-item.selected { background: var(--accent-dim); }
  .new-toc-item.dragging { opacity: 0.5; }
  .new-toc-item:last-child { border-bottom: none; }
  .new-toc-item .label { flex: 1; }
  .new-toc-item .target { 
    font-size: 10px; 
    color: var(--text-dim); 
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .new-toc-item .level-badge {
    font-size: 9px;
    padding: 2px 6px;
    border-radius: 3px;
    background: var(--accent-dim);
    color: var(--accent);
  }
  .toc-edit-btns {
    display: flex;
    gap: 6px;
    margin-top: 10px;
    flex-wrap: wrap;
  }
  .toc-edit-btns button {
    padding: 5px 10px;
    font-size: 11px;
  }
  .toc-edit-btns button.danger { background: #ffe5e5; color: #d32f2f; border-color: #ffcdd2; }
  .toc-edit-btns button.danger:hover { background: #ffcdd2; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

  /* Mobile */
  @media (max-width: 768px) {
    .sidebar { width: 220px; min-width: 220px; }
    .file-item { padding: 5px 8px; font-size: 10px; }
    .file-item .timestamp { display: none; }
  }

  /* ‚îÄ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ‚îÄ */
  .topbar {
    display: flex;
    align-items: center;
    gap: 12px;
    height: 48px;
    padding: 0 16px;
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .topbar .logo {
    font-weight: 600;
    font-size: 15px;
    color: var(--accent);
    letter-spacing: 0.5px;
  }
  .topbar .spacer { flex:1; }
  .topbar button {
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--font-ui);
    font-size: 12px;
    font-weight: 500;
    padding: 6px 14px;
    border-radius: 6px;
    cursor: pointer;
    transition: all .15s;
  }
  .topbar button:hover { background: var(--bg-hover); border-color: var(--accent); color: var(--text-bright); }
  .topbar button.primary { background: #ffd9df; border-color: #ffd9df; color: #4c4143; }
  .topbar button.primary:hover { background: #ff8b9a; }
  .topbar button.open-btn { background: #c4c1ef; border-color: #c4c1ef; color: white; }
  .topbar button.open-btn:hover { background: #7c6aff; }
  .topbar button.reset-btn { background: #b3deeb; border-color: #b3deeb; color: white; }
  .topbar button.reset-btn:hover { background: #69a4b7; }
  .topbar button:disabled { opacity: .35; cursor: default; }
  .topbar .fname {
    font-size: 12px;
    color: var(--text-dim);
    max-width: 500px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .theme-toggle {
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--text);
    font-size: 16px;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all .15s;
  }
  .theme-toggle:hover { background: var(--bg-hover); border-color: var(--accent); }

  /* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
  .layout {
    display: flex;
    height: calc(100dvh - 48px - 28px);
    overflow: hidden;
  }

  /* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
  .sidebar {
    width: 380px;
    min-width: 380px;
    background: var(--bg2);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .sidebar-header {
    padding: 10px 14px;
    font-size: 10px;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 1.2px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }
  .sidebar-header .controls {
    display: flex;
    gap: 4px;
    align-items: center;
    margin-left: auto;
  }
  .sort-btn, .action-btn {
    cursor: pointer;
    color: var(--text-dim);
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 4px;
    transition: all .15s;
    background: transparent;
    border: 1px solid transparent;
    font-family: var(--font-ui);
    font-weight: 600;
  }
  .sort-btn:hover, .action-btn:hover { 
    background: var(--bg3); 
    border-color: var(--border);
    color: var(--text);
  }
  .sort-btn.active { 
    background: var(--accent-dim);
    border-color: var(--accent);
    color: var(--accent);
  }
  .action-btn.toc-btn { background: #fff3bd; color: #2d3436; border-color: #ffda64; }
  .action-btn.toc-btn:hover { background: #ffeaa7; border-color: #f39c12; }
  .action-btn.search-btn { background: #c2f1d6; color: #2c2c2c; border-color: #83d5a6; }
  .action-btn.search-btn:hover { background: #7ae1a5; border-color: #7ae1a5; }

  .file-tree {
    flex: 1;
    overflow-y: auto;
    padding: 6px 0;
  }
  .file-group-label {
    padding: 8px 14px 4px;
    font-size: 9px;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 1px;
    cursor: pointer;
  }
  .file-group-label:hover { color: var(--text); }
  .file-group { margin-bottom: 4px; }
  .file-group.collapsed .file-group-items { display: none; }
  .file-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 14px;
    font-size: 11px;
    color: var(--text);
    cursor: pointer;
    transition: background .12s;
    white-space: nowrap;
    overflow: hidden;
  }
  .file-item:hover { background: var(--bg-hover); }
  .file-item.active {
    background: var(--accent-dim);
    color: var(--accent);
  }
  .file-item .icon {
    font-size: 13px;
    width: 16px;
    text-align: center;
    flex-shrink: 0;
  }
  .file-item .file-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 0;
  }
  .file-item .timestamp {
    font-size: 9px;
    color: var(--text-dim);
    font-family: var(--font-code);
    flex-shrink: 0;
  }
  .file-item.active .timestamp { color: var(--accent); }
  .file-item.modified { color: var(--red); }
  .file-item .spine-num {
    font-size: 9px;
    background: var(--accent-dim);
    color: var(--accent);
    padding: 1px 4px;
    border-radius: 3px;
    margin-right: 4px;
  }

  /* ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Editor tabs */
  .editor-tabs {
    display: flex;
    align-items: center;
    gap: 2px;
    padding: 6px 10px 0;
    background: var(--bg);
    flex-shrink: 0;
    overflow-x: auto;
  }
  .tab {
    padding: 6px 12px;
    font-size: 11px;
    color: var(--text-dim);
    border-radius: 6px 6px 0 0;
    cursor: pointer;
    background: transparent;
    border: none;
    font-family: var(--font-ui);
    transition: all .12s;
    white-space: nowrap;
    max-width: 160px;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .tab:hover { color: var(--text); background: var(--bg3); }
  .tab.active {
    background: var(--bg2);
    color: var(--text-bright);
    border: 1px solid var(--border);
    border-bottom: 1px solid var(--bg2);
    margin-bottom: -1px;
  }
  .tab.modified::before { content: "‚óè"; color: var(--yellow); margin-right: 4px; }
  .tab .close {
    opacity: .4;
    cursor: pointer;
    font-size: 14px;
  }
  .tab .close:hover { opacity: 1; color: var(--red); }

  /* Editor area */
  .editor-wrap {
    flex: 1;
    display: flex;
    flex-direction: column;
    border-top: 1px solid var(--border);
    overflow: hidden;
    background: var(--bg2);
  }

  /* Code editor */
  .code-editor {
    flex: 1;
    width: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-code);
    font-size: 13px;
    line-height: 1.7;
    padding: 16px 20px;
    resize: none;
    border: none;
    outline: none;
    overflow: auto;
    tab-size: 2;
  }
  .code-editor::selection { background: rgba(124,106,255,0.25); }

  /* TOC editor special */
  .toc-editor {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: var(--bg);
  }
  .toc-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid transparent;
    transition: all .12s;
    cursor: grab;
    margin-bottom: 4px;
  }
  .toc-item:hover { border-color: var(--border); background: var(--bg3); }
  .toc-item.dragging { opacity: .4; }
  .toc-item .drag-handle { color: var(--text-dim); font-size: 14px; cursor: grab; }
  .toc-item input.toc-label {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--text-bright);
    font-family: var(--font-ui);
    font-size: 13px;
    outline: none;
  }
  .toc-item input.toc-label:focus { border-bottom: 1px solid var(--accent); }
  .toc-item .toc-target {
    font-size: 10px;
    color: var(--text-dim);
    font-family: var(--font-code);
    background: var(--bg2);
    padding: 2px 8px;
    border-radius: 4px;
    max-width: 140px;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .toc-item button {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 14px;
    padding: 2px 6px;
    border-radius: 4px;
  }
  .toc-item button:hover { background: var(--bg3); color: var(--red); }
  .toc-actions {
    display: flex;
    gap: 8px;
    padding: 12px 20px;
    border-top: 1px solid var(--border);
    background: var(--bg2);
    flex-shrink: 0;
  }
  .toc-actions button {
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--font-ui);
    font-size: 11px;
    padding: 5px 12px;
    border-radius: 5px;
    cursor: pointer;
  }
  .toc-actions button:hover { border-color: var(--accent); color: var(--accent); }

  /* Image preview */
  .img-preview-wrap {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: var(--bg);
    gap: 16px;
    padding: 20px;
    overflow: auto;
  }
  .img-preview-wrap img { max-width: 100%; max-height: 60vh; border-radius: 8px; border: 1px solid var(--border); }
  .img-meta { font-size: 11px; color: var(--text-dim); font-family: var(--font-code); }
  .img-actions { display: flex; gap: 8px; }
  .img-actions button {
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--font-ui);
    font-size: 11px;
    padding: 5px 12px;
    border-radius: 5px;
    cursor: pointer;
  }
  .img-actions button:hover { border-color: var(--accent); color: var(--accent); }

  /* Empty state */
  .empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    color: var(--text-dim);
  }
  .empty-state .big-icon { font-size: 48px; opacity: .3; }
  .empty-state p { font-size: 13px; }

  /* Status bar */
  .statusbar {
    height: 28px;
    padding: 0 14px;
    background: var(--bg2);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 20px;
    font-size: 10px;
    color: var(--text-dim);
    flex-shrink: 0;
  }
  .statusbar .modified { color: var(--yellow); }

  /* Drop overlay */
  .drop-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(14,15,17,.85);
    z-index: 100;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 12px;
  }
  .drop-overlay.show { display: flex; }
  .drop-overlay .drop-box {
    border: 2px dashed var(--accent);
    border-radius: 16px;
    padding: 60px 80px;
    text-align: center;
  }
  .drop-overlay .drop-box p { font-size: 18px; color: var(--accent); font-weight: 500; }
  .drop-overlay .drop-box .sub { font-size: 12px; color: var(--text-dim); margin-top: 6px; }

  /* Modal */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 200;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.show { display: flex; }
  .modal {
    background: var(--bg2);
    border-radius: 12px;
    border: 1px solid var(--border);
    width: 90%;
    max-width: 800px;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 25px 50px rgba(0,0,0,0.25);
  }
  .modal-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .modal-header h3 { font-size: 15px; font-weight: 600; color: var(--text-bright); }
  .modal-header .close-btn {
    background: none;
    border: none;
    font-size: 20px;
    color: var(--text-dim);
    cursor: pointer;
  }
  .modal-header .close-btn:hover { color: var(--red); }
  .modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
  }
  .modal-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }
  .modal-footer button {
    padding: 8px 20px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid var(--border);
    background: var(--bg3);
    color: var(--text);
  }
  .modal-footer button:hover { border-color: var(--accent); }
  .modal-footer button.primary {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }
  .modal-footer button.primary:hover { opacity: 0.9; }

  /* Search modal */
  .search-input-wrap {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }
  .search-input-wrap input {
    flex: 1;
    padding: 10px 14px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--bg);
    color: var(--text);
    font-size: 13px;
    outline: none;
  }
  .search-input-wrap input:focus { border-color: var(--accent); }
  .search-options {
    display: flex;
    gap: 16px;
    margin-bottom: 15px;
  }
  .search-options label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    cursor: pointer;
  }
  .search-results {
    border: 1px solid var(--border);
    border-radius: 6px;
    max-height: 350px;
    overflow-y: auto;
    background: var(--bg);
  }
  .search-result-item {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    font-size: 12px;
  }
  .search-result-item:hover { background: var(--bg-hover); }
  .search-result-item:last-child { border-bottom: none; }
  .search-result-item .file-header {
    color: var(--accent);
    font-weight: 600;
    padding: 4px 0;
  }
  .search-result-item .line-info { color: var(--text-dim); }

  /* TOC Dialog styles */
  .toc-section {
    margin-bottom: 20px;
  }
  .toc-section-header {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-bright);
    margin-bottom: 10px;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
  }
  .toc-btn-row {
    display: flex;
    gap: 8px;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }
  .toc-btn-row button {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid var(--border);
    background: var(--bg3);
    color: var(--text);
  }
  .toc-btn-row button:hover { border-color: var(--accent); color: var(--accent); }
  .toc-btn-row button.success { background: #e8f5e9; color: #2e7d32; border-color: #81c784; }
  .toc-btn-row button.success:hover { background: #c8e6c9; }
  .toc-tree {
    border: 1px solid var(--border);
    border-radius: 6px;
    max-height: 200px;
    overflow-y: auto;
    background: var(--bg);
    margin-bottom: 15px;
  }
  .toc-tree-item {
    padding: 6px 12px;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .toc-tree-item:last-child { border-bottom: none; }
  .toc-tree-item.level-1 { background: #fff8dc; }
  .toc-tree-item.level-2 { background: #fffaf0; padding-left: 24px; }
  .toc-tree-item.level-3 { background: #ffffff; padding-left: 36px; }
  .new-toc-list {
    border: 1px solid var(--border);
    border-radius: 6px;
    max-height: 300px;
    overflow-y: auto;
    background: var(--bg);
  }
  .new-toc-item {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: grab;
    transition: background .1s;
  }
  .new-toc-item:hover { background: var(--bg-hover); }
  .new-toc-item.selected { background: var(--accent-dim); }
  .new-toc-item.dragging { opacity: 0.5; }
  .new-toc-item:last-child { border-bottom: none; }
  .new-toc-item .label { flex: 1; }
  .new-toc-item .target { 
    font-size: 10px; 
    color: var(--text-dim); 
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .new-toc-item .level-badge {
    font-size: 9px;
    padding: 2px 6px;
    border-radius: 3px;
    background: var(--accent-dim);
    color: var(--accent);
  }
  .toc-edit-btns {
    display: flex;
    gap: 6px;
    margin-top: 10px;
    flex-wrap: wrap;
  }
  .toc-edit-btns button {
    padding: 5px 10px;
    font-size: 11px;
  }
  .toc-edit-btns button.danger { background: #ffe5e5; color: #d32f2f; border-color: #ffcdd2; }
  .toc-edit-btns button.danger:hover { background: #ffcdd2; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

  /* Mobile */
  @media (max-width: 768px) {
    .sidebar { width: 220px; min-width: 220px; }
    .file-item { padding: 5px 8px; font-size: 10px; }
    .file-item .timestamp { display: none; }
  }

  /* Find & Replace Panel */
  .find-replace-panel {
    position: absolute;
    top: 10px;
    right: 20px;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    min-width: 400px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    display: none;
  }
  .find-replace-panel.active {
    display: block;
  }
  .find-replace-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }
  .find-replace-header h4 {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-bright);
  }
  .find-replace-close {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 20px;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.15s;
  }
  .find-replace-close:hover {
    background: var(--bg-hover);
    color: var(--text-bright);
  }
  .find-replace-input-group {
    margin-bottom: 10px;
  }
  .find-replace-input-group label {
    display: block;
    margin-bottom: 4px;
    font-size: 11px;
    color: var(--text-dim);
    font-weight: 500;
  }
  .find-replace-input {
    width: 100%;
    padding: 8px 12px;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-size: 13px;
    font-family: var(--font-ui);
    outline: none;
    transition: all 0.15s;
  }
  .find-replace-input:focus {
    border-color: var(--accent);
    background: var(--bg2);
  }
  .find-replace-options {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
    font-size: 11px;
  }
  .find-replace-option {
    display: flex;
    align-items: center;
    gap: 5px;
    color: var(--text);
  }
  .find-replace-option input[type="checkbox"] {
    cursor: pointer;
  }
  .find-replace-buttons {
    display: flex;
    gap: 6px;
  }
  .find-replace-btn {
    flex: 1;
    padding: 8px 12px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 11px;
    font-weight: 500;
    transition: all 0.15s;
  }
  .find-replace-btn:hover {
    opacity: 0.85;
  }
  .find-replace-btn-replace {
    background: var(--green);
  }
  .find-replace-btn-replace-all {
    background: var(--red);
  }
  .find-replace-results {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid var(--border);
    font-size: 11px;
    color: var(--text-dim);
  }

</style>
</head>
<body>

<!-- Drop overlay -->
<div class="drop-overlay" id="dropOverlay">
  <div class="drop-box">
    <p>üìñ EPUB ÌååÏùºÏùÑ Ïó¨Í∏∞Ïóê ÎìúÎ°≠</p>
    <p class="sub">.epub ÌååÏùºÎßå Í∞ÄÎä•</p>
  </div>
</div>

<!-- Search Modal -->
<div class="modal-overlay" id="searchModal">
  <div class="modal">
    <div class="modal-header">
      <h3>üîç Ï†ÑÏ≤¥ ÌååÏùº Í≤ÄÏÉâ</h3>
      <button class="close-btn" onclick="closeSearchModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="search-input-wrap">
        <input type="text" id="searchInput" placeholder="Ï∞æÏùÑ ÌÖçÏä§Ìä∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." onkeypress="if(event.key==='Enter')performSearch()"/>
        <button onclick="performSearch()" style="padding:10px 20px;background:var(--accent);color:white;border:none;border-radius:6px;cursor:pointer;">Í≤ÄÏÉâ</button>
      </div>
      <div class="search-input-wrap" style="margin-top:10px;">
        <input type="text" id="replaceInput" placeholder="Î∞îÍøÄ ÌÖçÏä§Ìä∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."/>
        <button onclick="replaceAllInFiles()" style="padding:10px 20px;background:var(--green);color:white;border:none;border-radius:6px;cursor:pointer;">Î™®Îëê Î∞îÍæ∏Í∏∞</button>
      </div>
      <div class="search-options">
        <label><input type="checkbox" id="caseSensitive"/> ÎåÄÏÜåÎ¨∏Ïûê Íµ¨Î∂Ñ</label>
        <label><input type="checkbox" id="htmlOnly" checked/> HTML ÌååÏùºÎßå</label>
      </div>
      <div style="margin-bottom:10px;font-size:12px;color:var(--text-dim);" id="searchResultCount">Í≤ÄÏÉâ Í≤∞Í≥º: 0Í∞ú</div>
      <div class="search-results" id="searchResults"></div>
    </div>
    <div class="modal-footer">
      <button onclick="closeSearchModal()">Îã´Í∏∞</button>
    </div>
  </div>
</div>

<!-- TOC Dialog Modal -->
<div class="modal-overlay" id="tocModal">
  <div class="modal" style="max-width:900px;">
    <div class="modal-header">
      <h3>üìö Î™©Ï∞® Ìé∏Ïßë</h3>
      <button class="close-btn" onclick="closeTocModal()">√ó</button>
    </div>
    <div class="modal-body">
      <!-- Load buttons -->
      <div class="toc-btn-row">
        <button class="success" onclick="loadOriginalToc()">üìö ÏõêÎ≥∏ Î™©Ï∞® Î∂àÎü¨Ïò§Í∏∞</button>
        <button onclick="loadTocFromHtml()">üìù Î™©Ï∞® Ï∞æÍ∏∞ (h1~h6)</button>
        <button onclick="loadTocFromFile()">üìÑ html Ï≤´ Î≥∏Î¨∏ÏóêÏÑú Ï∂îÏ∂ú</button>
      </div>
      
      <!-- Current TOC -->
      <div class="toc-section">
        <div class="toc-section-header">üí´ ÌòÑÏû¨ Î™©Ï∞® Íµ¨Ï°∞</div>
        <div class="toc-tree" id="currentTocTree"></div>
      </div>
      
      <!-- New TOC -->
      <div class="toc-section">
        <div class="toc-section-header">‚ú® ÏÉà Î™©Ï∞® (ÎìúÎûòÍ∑∏Î°ú ÏàúÏÑú Î≥ÄÍ≤Ω, ÌÅ¥Î¶≠ÏúºÎ°ú ÏÑ†ÌÉù)</div>
        <div class="new-toc-list" id="newTocList"></div>
        <div class="toc-edit-btns">
          <button onclick="moveNewTocItem(-1)">‚Üë ÏúÑÎ°ú</button>
          <button onclick="moveNewTocItem(1)">‚Üì ÏïÑÎûòÎ°ú</button>
          <button onclick="changeNewTocLevel(-1)">‚óÄ Î†àÎ≤® ÎÜíÏûÑ</button>
          <button onclick="changeNewTocLevel(1)">‚ñ∂ Î†àÎ≤® ÎÇÆÏ∂§</button>
          <button onclick="editNewTocLabel()">‚úèÔ∏è Ï†úÎ™© ÏàòÏ†ï</button>
          <button class="danger" onclick="deleteNewTocItem()">üóëÔ∏è ÏÇ≠Ï†ú</button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button onclick="closeTocModal()">Ï∑®ÏÜå</button>
      <button class="primary" onclick="applyNewToc()">Ï†ÅÏö©</button>
    </div>
  </div>
</div>

<!-- Top bar -->
<div class="topbar">
  <div class="logo">üëª EPUB Editor</div>
  <span class="fname" id="topFname">ÌååÏùº ÎØ∏Ïó¥Î¶º</span>
  <div class="spacer"></div>
  <button class="theme-toggle" id="btnTheme" title="ÌÖåÎßà Ï†ÑÌôò">üåô</button>
  <button class="open-btn" id="btnOpen">Open EPUB</button>
  <button id="btnSave" class="primary" disabled>Save EPUB</button>
  <button id="btnReset" class="reset-btn" disabled>Reset</button>
  <input type="file" id="fileInput" accept=".epub" style="display:none"/>
</div>

<!-- Layout -->
<div class="layout">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <span>FILE TREE</span>
      <div class="controls">
        <button class="action-btn search-btn" id="btnSearch" disabled onclick="openSearchModal()">Find</button>
        <button class="action-btn toc-btn" id="btnToc" disabled onclick="openTocModal()">TOC</button>
        <button class="sort-btn" id="sortSpine" title="Spine ÏàúÏÑú">üìñ</button>
        <button class="sort-btn active" id="sortType" title="ÌÉÄÏûÖÎ≥Ñ">TYPE</button>
        <button class="sort-btn" id="sortName" title="Ïù¥Î¶ÑÏàú">ABC</button>
      </div>
    </div>
    <div class="file-tree" id="fileTree">
      <div class="empty-state" style="padding:40px 14px; font-size:11px; text-align:center;">
        EPUB ÌååÏùºÏùÑ Ïó¥Î©¥<br/>ÎÇ¥Î∂Ä Íµ¨Ï°∞Í∞Ä ÌëúÏãúÎê©ÎãàÎã§
      </div>
    </div>
  </div>

  <!-- Main -->
  <div class="main">
    <div class="editor-tabs" id="editorTabs"></div>
    
  <div class="editor-wrap" id="editorWrap">
      <div class="empty-state">
        <div class="big-icon">üìñ</div>
        <p>ÏôºÏ™Ω ÌååÏùº Ìä∏Î¶¨ÏóêÏÑú Ìé∏ÏßëÌï† ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
      </div>
    </div>
  </div>
</div>

<!-- Status bar -->
<div class="statusbar">
  <span id="statusFile">‚Äî</span>
  <span id="statusType">‚Äî</span>
  <span id="statusModified"></span>
  <div style="flex:1"></div>
  <span id="statusTimestamp">‚Äî</span>
  <span id="statusSize">‚Äî</span>
</div>

<script>
  // ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
  let zip = null;
  let files = {};
  let fileTypes = {};
  let fileTimestamps = {};
  let openTabs = [];
  let activeTab = null;
  let modifiedFiles = new Set();
  let tocEntries = [];
  let newTocEntries = [];
  let selectedNewTocIndex = -1;
  let tocFilePath = null;
  let opfPath = null;
  let spine = [];
  let sortMode = 'type';
  let currentFileName = '';

  // ‚îÄ‚îÄ‚îÄ DOM ‚îÄ‚îÄ‚îÄ
  const dropOverlay = document.getElementById('dropOverlay');
  const fileTree = document.getElementById('fileTree');
  const editorTabs = document.getElementById('editorTabs');
  const editorWrap = document.getElementById('editorWrap');
  const fileInput = document.getElementById('fileInput');
  const btnOpen = document.getElementById('btnOpen');
  const btnSave = document.getElementById('btnSave');
  const btnReset = document.getElementById('btnReset');
  const btnTheme = document.getElementById('btnTheme');
  const btnSearch = document.getElementById('btnSearch');
  const btnToc = document.getElementById('btnToc');
  const topFname = document.getElementById('topFname');
  const statusFile = document.getElementById('statusFile');
  const statusType = document.getElementById('statusType');
  const statusModified = document.getElementById('statusModified');
  const statusTimestamp = document.getElementById('statusTimestamp');
  const statusSize = document.getElementById('statusSize');

  // ‚îÄ‚îÄ‚îÄ THEME ‚îÄ‚îÄ‚îÄ
  btnTheme.addEventListener('click', () => {
    document.documentElement.classList.toggle('dark');
    const isDark = document.documentElement.classList.contains('dark');
    btnTheme.textContent = isDark ? 'üîÜ' : 'üåô';
  });

  // ‚îÄ‚îÄ‚îÄ DRAG & DROP ‚îÄ‚îÄ‚îÄ
  document.body.addEventListener('dragenter', e => { 
    e.preventDefault(); 
    e.stopPropagation();
    dropOverlay.classList.add('show'); 
  });
  
  document.body.addEventListener('dragleave', e => { 
    e.preventDefault();
    e.stopPropagation();
    if(e.target === dropOverlay || e.target === document.body) {
      dropOverlay.classList.remove('show'); 
    }
  });
  
  document.body.addEventListener('dragover', e => {
    e.preventDefault();
    e.stopPropagation();
  });
  
  document.body.addEventListener('drop', async e => {
    e.preventDefault();
    e.stopPropagation();
    dropOverlay.classList.remove('show');
    
    if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length > 0) {
      const file = [...e.dataTransfer.files].find(f => f.name.toLowerCase().endsWith('.epub'));
      if(file) {
        loadEpub(file);
      } else {
        alert('EPUB ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§');
      }
    }
  });

  // ‚îÄ‚îÄ‚îÄ FILE INPUT ‚îÄ‚îÄ‚îÄ
  btnOpen.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', () => {
    if(fileInput.files[0]) loadEpub(fileInput.files[0]);
  });

  // ‚îÄ‚îÄ‚îÄ RESET ‚îÄ‚îÄ‚îÄ
  btnReset.addEventListener('click', resetEditor);

  function resetEditor() {
    zip = null;
    files = {};
    fileTypes = {};
    fileTimestamps = {};
    openTabs = [];
    activeTab = null;
    modifiedFiles.clear();
    tocEntries = [];
    newTocEntries = [];
    tocFilePath = null;
    opfPath = null;
    spine = [];
    currentFileName = '';
    
    topFname.textContent = 'ÌååÏùº ÎØ∏Ïó¥Î¶º';
    btnSave.disabled = true;
    btnReset.disabled = true;
    btnSearch.disabled = true;
    btnToc.disabled = true;
    
    fileTree.innerHTML = `
      <div class="empty-state" style="padding:40px 14px; font-size:11px; text-align:center;">
        EPUB ÌååÏùºÏùÑ Ïó¥Î©¥<br/>ÎÇ¥Î∂Ä Íµ¨Ï°∞Í∞Ä ÌëúÏãúÎê©ÎãàÎã§
      </div>
    `;
    editorTabs.innerHTML = '';
    editorWrap.innerHTML = `
      <div class="empty-state">
        <div class="big-icon">üìñ</div>
        <p>ÏôºÏ™Ω ÌååÏùº Ìä∏Î¶¨ÏóêÏÑú Ìé∏ÏßëÌï† ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
      </div>
    `;
    updateStatus();
  }

  // ‚îÄ‚îÄ‚îÄ SORT BUTTONS ‚îÄ‚îÄ‚îÄ
  document.getElementById('sortSpine').addEventListener('click', () => { sortMode = 'spine'; renderFileTree(); updateSortButtons(); });
  document.getElementById('sortType').addEventListener('click', () => { sortMode = 'type'; renderFileTree(); updateSortButtons(); });
  document.getElementById('sortName').addEventListener('click', () => { sortMode = 'name'; renderFileTree(); updateSortButtons(); });

  function updateSortButtons() {
    document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
    if(sortMode === 'spine') document.getElementById('sortSpine').classList.add('active');
    else if(sortMode === 'type') document.getElementById('sortType').classList.add('active');
    else document.getElementById('sortName').classList.add('active');
  }

  // ‚îÄ‚îÄ‚îÄ LOAD EPUB ‚îÄ‚îÄ‚îÄ
  async function loadEpub(file) {
    zip = await JSZip.loadAsync(file);
    files = {};
    fileTypes = {};
    fileTimestamps = {};
    modifiedFiles.clear();
    openTabs = [];
    activeTab = null;
    spine = [];
    tocEntries = [];
    tocFilePath = null;
    opfPath = null;
    currentFileName = file.name;

    for(const [path, zipEntry] of Object.entries(zip.files)) {
      if(zipEntry.dir) continue;
      fileTimestamps[path] = zipEntry.date;
      const ext = getExt(path).toLowerCase();
      const textExts = ['html','xhtml','htm','xml','opf','ncx','css','txt','svg','js','json'];
      if(textExts.includes(ext)) {
        files[path] = await zipEntry.async('string');
        detectFileType(path);
      } else {
        files[path] = await zipEntry.async('uint8array');
        fileTypes[path] = getBinaryType(path);
      }
    }

    parseEpubStructure();
    renderFileTree();
    renderTabs();

    topFname.textContent = `${currentFileName} ¬∑ ${formatBytes(file.size)}`;
    btnSave.disabled = false;
    btnReset.disabled = false;
    btnSearch.disabled = false;
    btnToc.disabled = false;
  }

  function detectFileType(path) {
    const content = files[path];
    const lower = path.toLowerCase();
    if(lower.endsWith('.opf') || (typeof content === 'string' && content.includes('<package'))) fileTypes[path] = 'opf';
    else if(lower.endsWith('.ncx')) fileTypes[path] = 'ncx';
    else if(lower.endsWith('.html') || lower.endsWith('.xhtml') || lower.endsWith('.htm')) fileTypes[path] = 'html';
    else if(lower.endsWith('.css')) fileTypes[path] = 'css';
    else if(lower.endsWith('.xml')) fileTypes[path] = 'xml';
    else fileTypes[path] = 'text';
  }

  function getBinaryType(path) {
    const ext = getExt(path).toLowerCase();
    if(['jpg','jpeg','png','gif','svg','webp'].includes(ext)) return 'image';
    if(['ttf','otf','woff','woff2'].includes(ext)) return 'font';
    return 'binary';
  }

  // ‚îÄ‚îÄ‚îÄ PARSE EPUB STRUCTURE ‚îÄ‚îÄ‚îÄ
  function parseEpubStructure() {
    // Find OPF
    const containerPath = 'META-INF/container.xml';
    if(files[containerPath]) {
      const match = files[containerPath].match(/full-path\s*=\s*["']([^"']+)["']/i);
      if(match) opfPath = match[1];
    }
    if(!opfPath) {
      for(const p in fileTypes) {
        if(fileTypes[p] === 'opf') { opfPath = p; break; }
      }
    }
    if(!opfPath) {
      for(const p in files) {
        if(p.toLowerCase().endsWith('.opf')) { opfPath = p; fileTypes[p] = 'opf'; break; }
      }
    }

    if(!opfPath || !files[opfPath]) return;

    const content = files[opfPath];
    const opfDir = opfPath.includes('/') ? opfPath.split('/').slice(0,-1).join('/') + '/' : '';

    // Parse spine
    const idrefs = [...content.matchAll(/<itemref\s+[^>]*idref\s*=\s*["']([^"']+)["']/gi)].map(m => m[1]);
    const idToHref = {};
    for(const m of content.matchAll(/<item[^>]+id\s*=\s*["']([^"']+)["'][^>]+href\s*=\s*["']([^"']+)["']/gi)) {
      idToHref[m[1]] = m[2];
    }
    for(const m of content.matchAll(/<item[^>]+href\s*=\s*["']([^"']+)["'][^>]+id\s*=\s*["']([^"']+)["']/gi)) {
      idToHref[m[2]] = m[1];
    }
    spine = idrefs.map(id => idToHref[id] ? (opfDir + idToHref[id]).replace('//','/') : null).filter(Boolean);

    // Find TOC
    for(const p in files) {
      if(p.toLowerCase().includes('nav.xhtml') || p.toLowerCase().includes('toc.ncx')) {
        tocFilePath = p;
        parseToc(p);
        break;
      }
    }
  }

  function parseToc(path) {
    const content = files[path];
    tocEntries = [];
    const tocDir = path.includes('/') ? path.split('/').slice(0,-1).join('/') + '/' : '';

    if(path.endsWith('.ncx')) {
      // Parse NCX - handle hierarchy
      const navPointRegex = /<navPoint[^>]*>([\s\S]*?)<\/navPoint>/gi;
      const parseNavPoints = (str, level = 1) => {
        const results = [];
        let match;
        const regex = /<navPoint[^>]*>([\s\S]*?)<\/navPoint>/gi;
        while((match = regex.exec(str)) !== null) {
          const inner = match[1];
          const labelMatch = inner.match(/<navLabel>\s*<text>([^<]+)<\/text>\s*<\/navLabel>/i);
          const srcMatch = inner.match(/<content\s+src="([^"]+)"/i);
          if(labelMatch && srcMatch) {
            const entry = {
              label: labelMatch[1],
              content: tocDir + srcMatch[1],
              level: level,
              children: []
            };
            // Find nested navPoints
            const nestedMatch = inner.match(/<navPoint[\s\S]*<\/navPoint>/gi);
            if(nestedMatch) {
              entry.children = parseNavPoints(nestedMatch.join(''), level + 1);
            }
            results.push(entry);
          }
        }
        return results;
      };
      // Simple flat parsing for now
      for(const m of content.matchAll(/<navLabel>\s*<text>([^<]+)<\/text>\s*<\/navLabel>\s*<content\s+src="([^"]+)"/gi)) {
        tocEntries.push({ label: m[1], content: tocDir + m[2], level: 1 });
      }
    } else {
      // Parse nav.xhtml
      for(const m of content.matchAll(/<a\s+href="([^"]+)">([^<]+)<\/a>/gi)) {
        tocEntries.push({ label: m[2], content: tocDir + m[1], level: 1 });
      }
    }
  }

  // ‚îÄ‚îÄ‚îÄ RENDER FILE TREE ‚îÄ‚îÄ‚îÄ
  function renderFileTree() {
    if(!Object.keys(files).length) return;

    const allFiles = Object.keys(files).map(p => ({ path: p, type: fileTypes[p] || 'other' }));
    let html = '';

    if(sortMode === 'spine') {
      // Spine files first
      const spineFiles = spine.filter(p => files[p]);
      const otherFiles = allFiles.filter(f => !spine.includes(f.path)).sort((a,b) => naturalSort(a.path, b.path));
      
      spineFiles.forEach((path, idx) => {
        const f = { path, type: fileTypes[path] };
        html += renderFileItem(f, idx + 1);
      });
      if(otherFiles.length) {
        html += `<div class="file-group-label">Í∏∞ÌÉÄ ÌååÏùº (${otherFiles.length})</div>`;
        otherFiles.forEach(f => { html += renderFileItem(f); });
      }
    } else if(sortMode === 'name') {
      allFiles.sort((a,b) => naturalSort(a.path, b.path));
      allFiles.forEach(f => { html += renderFileItem(f); });
    } else {
      // Group by type
      const groups = {};
      const groupOrder = ['html','css','image','xml','opf','ncx','font','text','binary'];
      const groupNames = { html:'Text', css:'Styles', image:'Images', xml:'XML', opf:'OPF', ncx:'NCX', font:'Fonts', text:'Etc', binary:'Binary' };
      allFiles.forEach(f => {
        if(!groups[f.type]) groups[f.type] = [];
        groups[f.type].push(f);
      });
      groupOrder.forEach(type => {
        if(!groups[type]) return;
        groups[type].sort((a,b) => naturalSort(a.path, b.path));
        html += `<div class="file-group">
          <div class="file-group-label" onclick="this.parentElement.classList.toggle('collapsed')">üìÅ ${groupNames[type] || type.toUpperCase()} (${groups[type].length})</div>
          <div class="file-group-items">${groups[type].map(f => renderFileItem(f)).join('')}</div>
        </div>`;
      });
    }

    fileTree.innerHTML = html;
    fileTree.querySelectorAll('.file-item').forEach(el => {
      el.addEventListener('click', () => openFile(el.dataset.path));
    });
  }

  function renderFileItem(f, spineIndex = null) {
    const icon = getFileIcon(f.type);
    const name = f.path.split('/').pop();
    const ts = fileTimestamps[f.path];
    const timestamp = ts ? formatTimestamp(ts) : '';
    const isActive = activeTab === f.path;
    const isModified = modifiedFiles.has(f.path);
    
    let classes = 'file-item';
    if(isActive) classes += ' active';
    if(isModified) classes += ' modified';
    
    let spineHtml = spineIndex ? `<span class="spine-num">${spineIndex}</span>` : '';
    let modIcon = isModified ? 'üî¥ ' : '';
    
    return `<div class="${classes}" data-path="${f.path}">
      ${spineHtml}
      <span class="icon">${modIcon}${icon}</span>
      <span class="file-name">${name}</span>
      <span class="timestamp">${timestamp}</span>
    </div>`;
  }

  function getFileIcon(type) {
    const icons = { html:'üìÑ', css:'üé®', image:'üñºÔ∏è', xml:'üìã', opf:'üì¶', ncx:'üìë', font:'üî§', text:'üìù', binary:'üì¶' };
    return icons[type] || 'üìÑ';
  }

  // ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ
  function renderTabs() {
    editorTabs.innerHTML = openTabs.map(tab => {
      const name = tab.path.split('/').pop();
      const isActive = tab.path === activeTab;
      const isModified = modifiedFiles.has(tab.path);
      let classes = 'tab';
      if(isActive) classes += ' active';
      if(isModified) classes += ' modified';
      return `<div class="${classes}" data-path="${tab.path}">
        <span class="tab-name">${name}</span>
        <span class="close" onclick="event.stopPropagation();closeTab('${tab.path.replace(/'/g,"\\'")}')">&times;</span>
      </div>`;
    }).join('');

    editorTabs.querySelectorAll('.tab').forEach(el => {
      el.addEventListener('click', () => {
        activeTab = el.dataset.path;
        renderTabs();
        renderEditor();
        renderFileTree();
        updateStatus();
      });
    });
  }

  function closeTab(path) {
    openTabs = openTabs.filter(t => t.path !== path);
    if(activeTab === path) {
      activeTab = openTabs.length ? openTabs[openTabs.length-1].path : null;
    }
    renderTabs();
    if(activeTab) renderEditor();
    else editorWrap.innerHTML = `<div class="empty-state"><div class="big-icon">üìñ</div><p>ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p></div>`;
    renderFileTree();
    updateStatus();
  }

  // ‚îÄ‚îÄ‚îÄ OPEN FILE ‚îÄ‚îÄ‚îÄ
  function openFile(path) {
    if(!openTabs.find(t => t.path === path)) {
      openTabs.push({ path });
    }
    activeTab = path;
    renderTabs();
    renderEditor();
    renderFileTree();
    updateStatus();
  }

  // ‚îÄ‚îÄ‚îÄ RENDER EDITOR ‚îÄ‚îÄ‚îÄ
  function renderEditor() {
    if(!activeTab) return;
    const type = fileTypes[activeTab];

    if(type === 'image') {
      renderImagePreview();
    } else if(['html','xml','opf','ncx','css','text'].includes(type)) {
      renderTextEditor();
    } else {
      editorWrap.innerHTML = `<div class="empty-state"><p>Î∞îÏù¥ÎÑàÎ¶¨ ÌååÏùºÏùÄ Ìé∏ÏßëÌï† Ïàò ÏóÜÏäµÎãàÎã§</p></div>`;
    }
  }

  function renderTextEditor() {
    const content = files[activeTab] || '';
    editorWrap.innerHTML = `<textarea class="code-editor" id="codeEditor">${escHtml(content)}</textarea>`;
    const editor = document.getElementById('codeEditor');
    editor.addEventListener('input', () => {
      files[activeTab] = editor.value;
      if(!modifiedFiles.has(activeTab)) {
        modifiedFiles.add(activeTab);
        renderTabs();
        renderFileTree();
        updateStatus();
      }
    });
    // Handle tab key
    editor.addEventListener('keydown', e => {
      if(e.key === 'Tab') {
        e.preventDefault();
        const start = editor.selectionStart;
        const end = editor.selectionEnd;
        editor.value = editor.value.substring(0, start) + '  ' + editor.value.substring(end);
        editor.selectionStart = editor.selectionEnd = start + 2;
      }
    });
  }

  function renderImagePreview() {
    const data = files[activeTab];
    const ext = getExt(activeTab).toLowerCase();
    const mimeMap = { jpg:'image/jpeg', jpeg:'image/jpeg', png:'image/png', gif:'image/gif', svg:'image/svg+xml', webp:'image/webp' };
    const mime = mimeMap[ext] || 'image/png';
    let src;
    if(data instanceof Uint8Array) {
      const blob = new Blob([data], {type: mime});
      src = URL.createObjectURL(blob);
    } else {
      src = 'data:' + mime + ';base64,' + btoa(data);
    }
    const sizeStr = data instanceof Uint8Array ? formatBytes(data.byteLength) : formatBytes(data.length);
  
    editorWrap.innerHTML = `
      <div class="img-preview-wrap">
        <img src="${src}" alt="preview" onload="updateImageDimensions(this)"/>
        <div class="img-meta" id="imgMeta">${activeTab} ¬∑ ${sizeStr} ¬∑ ${ext.toUpperCase()}</div>
        <div class="img-actions">
          <button onclick="replaceImage()">ÍµêÏ≤¥</button>
          <button onclick="downloadImage('${src}','${activeTab.split('/').pop()}')">Îã§Ïö¥Î°úÎìú</button>
        </div>
      </div>
    `;
  }

  function updateImageDimensions(img) {
    const meta = document.getElementById('imgMeta');
    if(meta && img.naturalWidth && img.naturalHeight) {
      const currentText = meta.textContent;
      meta.textContent = currentText + ` ¬∑ ${img.naturalWidth}√ó${img.naturalHeight}`;
    }
  }
  function replaceImage() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = async () => {
      const file = input.files[0];
      if(!file) return;
      const arrayBuffer = await file.arrayBuffer();
      files[activeTab] = new Uint8Array(arrayBuffer);
      modifiedFiles.add(activeTab);
      renderEditor();
      renderTabs();
      renderFileTree();
      updateStatus();
    };
    input.click();
  }

  function downloadImage(src, fname) {
    const a = document.createElement('a');
    a.href = src;
    a.download = fname;
    a.click();
  }

  // ‚îÄ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ‚îÄ
  btnSave.addEventListener('click', async () => {
    if(!zip) return;
    
    const mimetimeTime = (zip.files['mimetype'] && zip.files['mimetype'].date) ? zip.files['mimetype'].date : new Date();
    
    for(const path in files) {
      const data = files[path];
      const options = {};
      if(fileTimestamps[path] && !modifiedFiles.has(path)) {
        options.date = fileTimestamps[path];
      } else {
        options.date = new Date();
      }
      zip.file(path, data, options);
    }
    
    Object.keys(zip.files).forEach(path => {
      if(zip.files[path].dir) zip.files[path].date = mimetimeTime;
    });
    if(zip.files['mimetype']) zip.files['mimetype'].date = mimetimeTime;
  
    const blob = await zip.generateAsync({ 
    type: 'blob',
    mimeType: 'application/epub+zip'
    });
    
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = currentFileName;
    a.click();
    URL.revokeObjectURL(url);
    
    modifiedFiles.forEach(path => { fileTimestamps[path] = new Date(); });
    modifiedFiles.clear();
    renderTabs();
    renderFileTree();
    updateStatus();
  });

  // ‚îÄ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ‚îÄ
  function openSearchModal() {
    document.getElementById('searchModal').classList.add('show');
    document.getElementById('searchInput').focus();
  }

  function closeSearchModal() {
    document.getElementById('searchModal').classList.remove('show');
    // ÌôîÎ©¥ ÏÉàÎ°úÍ≥†Ïπ®
    renderFileTree();
    renderTabs();
    updateStatus();
  }

  function performSearch() {
    const query = document.getElementById('searchInput').value.trim();
    if(!query) return;
    
    const caseSensitive = document.getElementById('caseSensitive').checked;
    const htmlOnly = document.getElementById('htmlOnly').checked;
    
    const results = [];
    for(const [path, content] of Object.entries(files)) {
      if(typeof content !== 'string') continue;
      if(htmlOnly && !path.toLowerCase().match(/\.(html|xhtml)$/)) continue;
      
      const lines = content.split('\n');
      lines.forEach((line, idx) => {
        const searchLine = caseSensitive ? line : line.toLowerCase();
        const searchQuery = caseSensitive ? query : query.toLowerCase();
        if(searchLine.includes(searchQuery)) {
          results.push({ path, lineNum: idx + 1, text: line.trim().substring(0, 100) });
        }
      });
    }
    
    document.getElementById('searchResultCount').textContent = `Í≤ÄÏÉâ Í≤∞Í≥º: ${results.length}Í∞ú`;
    
    let html = '';
    let currentFile = '';
    results.forEach(r => {
      if(r.path !== currentFile) {
        currentFile = r.path;
        html += `<div class="search-result-item"><div class="file-header">üìÑ ${r.path}</div></div>`;
      }
      html += `<div class="search-result-item" onclick="openFileAtLine('${r.path.replace(/'/g,"\\'")}', ${r.lineNum})">
        <span class="line-info">Line ${r.lineNum}:</span> ${escHtml(r.text)}
      </div>`;
    });
    
    document.getElementById('searchResults').innerHTML = html || '<div style="padding:20px;text-align:center;color:var(--text-dim);">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</div>';
  }

  function openFileAtLine(path, lineNum) {
    closeSearchModal();
    openFile(path);
    setTimeout(() => {
      const editor = document.getElementById('codeEditor');
      if(editor) {
        const lines = editor.value.split('\n');
        let pos = 0;
        for(let i = 0; i < lineNum - 1 && i < lines.length; i++) {
          pos += lines[i].length + 1;
        }
        editor.focus();
        editor.setSelectionRange(pos, pos + lines[lineNum-1].length);
        // Scroll to position
        const lineHeight = 22;
        editor.scrollTop = (lineNum - 5) * lineHeight;
      }
    }, 100);
  }

  // Keyboard shortcut
  document.addEventListener('keydown', e => {
    if((e.ctrlKey || e.metaKey) && e.key === 'f' && Object.keys(files).length) {
      e.preventDefault();
      openSearchModal();
    }
  });

  // ‚îÄ‚îÄ‚îÄ TOC DIALOG ‚îÄ‚îÄ‚îÄ
  function openTocModal() {
    newTocEntries = [];
    selectedNewTocIndex = -1;
    renderCurrentToc();
    renderNewTocList();
    document.getElementById('tocModal').classList.add('show');
  }

  function closeTocModal() {
    document.getElementById('tocModal').classList.remove('show');
  }

  function renderCurrentToc() {
    const container = document.getElementById('currentTocTree');
    if(!tocEntries.length) {
      container.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-dim);">Î™©Ï∞®Í∞Ä ÏóÜÏäµÎãàÎã§</div>';
      return;
    }
    
    const levelIcons = ['üìï','üìô','üìí','üìó','üìò','üìì'];
    container.innerHTML = tocEntries.map(e => {
      const level = e.level || 1;
      const icon = levelIcons[Math.min(level-1, 5)];
      return `<div class="toc-tree-item level-${level}">
        <span>${icon}</span>
        <span style="flex:1">${escHtml(e.label)}</span>
        <span style="font-size:10px;color:var(--text-dim)">${e.content.split('/').pop()}</span>
      </div>`;
    }).join('');
  }

  function renderNewTocList() {
    const container = document.getElementById('newTocList');
    if(!newTocEntries.length) {
      container.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-dim);">Î™©Ï∞®Î•º Î∂àÎü¨Ïò§ÏÑ∏Ïöî</div>';
      return;
    }
    
    const levelIcons = ['üìï','üìô','üìí','üìó','üìò','üìì'];
    container.innerHTML = newTocEntries.map((e, idx) => {
      const level = e.level || 1;
      const icon = levelIcons[Math.min(level-1, 5)];
      const indent = '  '.repeat(level - 1);
      const selected = idx === selectedNewTocIndex ? ' selected' : '';
      return `<div class="new-toc-item${selected}" data-idx="${idx}" draggable="true">
        <span>${indent}${icon}</span>
        <span class="label">${escHtml(e.label)}</span>
        <span class="target">${e.content.split('/').pop()}</span>
        <span class="level-badge">Lv${level}</span>
      </div>`;
    }).join('');
    
    // Add event listeners
    container.querySelectorAll('.new-toc-item').forEach(el => {
      el.addEventListener('click', () => {
        selectedNewTocIndex = parseInt(el.dataset.idx);
        renderNewTocList();
      });
      el.addEventListener('dragstart', e => {
        el.classList.add('dragging');
        e.dataTransfer.setData('text/plain', el.dataset.idx);
      });
      el.addEventListener('dragend', () => el.classList.remove('dragging'));
      el.addEventListener('dragover', e => e.preventDefault());
      el.addEventListener('drop', e => {
        e.preventDefault();
        const fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
        const toIdx = parseInt(el.dataset.idx);
        if(fromIdx !== toIdx) {
          const item = newTocEntries.splice(fromIdx, 1)[0];
          newTocEntries.splice(toIdx, 0, item);
          selectedNewTocIndex = toIdx;
          renderNewTocList();
        }
      });
    });
  }

  function loadOriginalToc() {
    if(!tocEntries.length) {
      alert('ÏõêÎ≥∏ Î™©Ï∞®Í∞Ä ÏóÜÏäµÎãàÎã§.');
      return;
    }
    newTocEntries = tocEntries.map(e => ({...e}));
    selectedNewTocIndex = -1;
    renderNewTocList();
    alert(`${newTocEntries.length}Í∞úÏùò Î™©Ï∞® Ìï≠Î™©ÏùÑ Î∂àÎü¨ÏôîÏäµÎãàÎã§.`);
  }

  function loadTocFromHtml() {
    if(!spine.length) {
      alert('spine Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.');
      return;
    }
    
    newTocEntries = [];
    spine.forEach(filePath => {
      if(!files[filePath] || typeof files[filePath] !== 'string') return;
      const content = files[filePath];
      
      // Find h1~h6 tags
      const headingRegex = /<(h[1-6])[^>]*>(.*?)<\/\1>/gi;
      let match;
      while((match = headingRegex.exec(content)) !== null) {
        const level = parseInt(match[1][1]);
        const text = match[2].replace(/<[^>]+>/g, '').replace(/\s+/g, ' ').trim();
        if(text) {
          newTocEntries.push({ label: text, content: filePath, level });
        }
      }
      
      // Find class="title", "toc", "chapter"
      const classRegex = /<(\w+)\s+[^>]*class=["'][^"']*?(title|toc|chapter)[^"']*?["'][^>]*>(.*?)<\/\1>/gi;
      while((match = classRegex.exec(content)) !== null) {
        const text = match[3].replace(/<[^>]+>/g, '').replace(/\s+/g, ' ').trim();
        if(text && !newTocEntries.find(e => e.label === text && e.content === filePath)) {
          newTocEntries.push({ label: text, content: filePath, level: 1 });
        }
      }
    });
    
    selectedNewTocIndex = -1;
    renderNewTocList();
    alert(`${newTocEntries.length}Í∞úÏùò Î™©Ï∞® Ìï≠Î™©ÏùÑ Ï∞æÏïòÏäµÎãàÎã§.`);
  }

  function loadTocFromFile() {
    if(!spine.length) {
      alert('spine Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.');
      return;
    }
    
    newTocEntries = [];
    spine.forEach(filePath => {
      if(!files[filePath] || typeof files[filePath] !== 'string') return;
      const content = files[filePath];
      
      // Find body content
      const bodyMatch = content.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
      if(bodyMatch) {
        const bodyContent = bodyMatch[1];
        // Find first meaningful text
        const tagMatch = bodyContent.match(/<(\w+)[^>]*>([\s\S]*?)<\/\1>/);
        if(tagMatch) {
          const text = tagMatch[2].replace(/<[^>]+>/g, '').replace(/\s+/g, ' ').trim();
          if(text.length >= 1) {
            newTocEntries.push({ label: text.substring(0, 100), content: filePath, level: 1 });
          }
        }
      }
    });
    
    selectedNewTocIndex = -1;
    renderNewTocList();
    alert(`${newTocEntries.length}Í∞úÏùò Î™©Ï∞® Ìï≠Î™©ÏùÑ Ï∞æÏïòÏäµÎãàÎã§.`);
  }

  function moveNewTocItem(dir) {
    if(selectedNewTocIndex < 0) return;
    const newIdx = selectedNewTocIndex + dir;
    if(newIdx < 0 || newIdx >= newTocEntries.length) return;
    const item = newTocEntries.splice(selectedNewTocIndex, 1)[0];
    newTocEntries.splice(newIdx, 0, item);
    selectedNewTocIndex = newIdx;
    renderNewTocList();
  }

  function changeNewTocLevel(dir) {
    if(selectedNewTocIndex < 0) return;
    const item = newTocEntries[selectedNewTocIndex];
    const newLevel = (item.level || 1) + dir;
    if(newLevel < 1 || newLevel > 6) return;
    item.level = newLevel;
    renderNewTocList();
  }

  function editNewTocLabel() {
    if(selectedNewTocIndex < 0) return;
    const item = newTocEntries[selectedNewTocIndex];
    const newLabel = prompt('ÏÉà Ï†úÎ™©:', item.label);
    if(newLabel !== null && newLabel.trim()) {
      item.label = newLabel.trim();
      renderNewTocList();
    }
  }

  function deleteNewTocItem() {
    if(selectedNewTocIndex < 0) return;
    if(!confirm('ÏÑ†ÌÉùÌïú Ìï≠Î™©ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
    newTocEntries.splice(selectedNewTocIndex, 1);
    selectedNewTocIndex = -1;
    renderNewTocList();
  }

  function applyNewToc() {
    if(!newTocEntries.length) {
      alert('Ï†ÅÏö©Ìï† Î™©Ï∞®Í∞Ä ÏóÜÏäµÎãàÎã§.');
      return;
    }
    if(!tocFilePath || !files[tocFilePath]) {
      alert('TOC ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
      return;
    }
    
    tocEntries = newTocEntries.map(e => ({...e}));
    
    // Update toc.ncx
    if(tocFilePath.endsWith('.ncx')) {
      rebuildNcxXml();
    } else {
      rebuildNavHtml();
    }
    
    modifiedFiles.add(tocFilePath);
    renderTabs();
    renderFileTree();
    updateStatus();
    closeTocModal();
    alert('Î™©Ï∞®Í∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§!');
  }

  function rebuildNcxXml() {
    const original = files[tocFilePath];
    const ncxDir = tocFilePath.includes('/') ? tocFilePath.split('/').slice(0,-1).join('/') + '/' : '';
    
    // Í≥ÑÏ∏µ Íµ¨Ï°∞Ïùò navPoint ÏÉùÏÑ±
    let playOrder = 0;
    
    function buildNavPoints(entries, startIdx, parentLevel) {
      let result = '';
      let i = startIdx;
      
      while(i < entries.length) {
        const entry = entries[i];
        const level = entry.level || 1;
        
        // ÌòÑÏû¨ Î†àÎ≤®Ïù¥ Î∂ÄÎ™®Î≥¥Îã§ ÏûëÍ±∞ÎÇò Í∞ôÏúºÎ©¥ (Ïà´ÏûêÍ∞Ä ÏûëÏúºÎ©¥) ÏÉÅÏúÑÎ°ú ÎèåÏïÑÍ∞ê
        if(level <= parentLevel) {
          break;
        }
        
        playOrder++;
        let relTarget = entry.content;
        if(relTarget.startsWith(ncxDir)) relTarget = relTarget.slice(ncxDir.length);
        
        const baseIndent = '  '.repeat(level);
        
        result += `${baseIndent}<navPoint id="navPoint-${playOrder}" playOrder="${playOrder}">\n`;
        result += `${baseIndent}  <navLabel><text>${escHtml(entry.label)}</text></navLabel>\n`;
        result += `${baseIndent}  <content src="${escHtml(relTarget)}"/>\n`;
        
        // Îã§Ïùå Ìï≠Î™©Ïù¥ ÌïòÏúÑ Î†àÎ≤®Ïù∏ÏßÄ ÌôïÏù∏ÌïòÏó¨ Ïû¨Í∑Ä Ï≤òÎ¶¨
        if(i + 1 < entries.length && (entries[i + 1].level || 1) > level) {
          const childResult = buildNavPoints(entries, i + 1, level);
          result += childResult.content;
          i = childResult.nextIdx - 1;
        }
        
        result += `${baseIndent}</navPoint>\n`;
        i++;
      }
      
      return { content: result, nextIdx: i };
    }
    
    // Î†àÎ≤® 1Î∂ÄÌÑ∞ ÏãúÏûëÌïòÏó¨ Í≥ÑÏ∏µ Íµ¨Ï°∞ ÏÉùÏÑ±
    const hierarchyResult = buildNavPoints(tocEntries, 0, 0);
    const navPoints = hierarchyResult.content;
    
    files[tocFilePath] = original.replace(/<navMap[^>]*>[\s\S]*?<\/navMap>/i, `<navMap>\n${navPoints}</navMap>`);
  }

  function rebuildNavHtml() {
    const original = files[tocFilePath];
    const navDir = tocFilePath.includes('/') ? tocFilePath.split('/').slice(0,-1).join('/') + '/' : '';
    
    // Ï§ëÏ≤©Îêú ol/li Íµ¨Ï°∞ ÏÉùÏÑ±
    function buildNestedOl(entries, startIdx, parentLevel) {
      let html = '';
      let i = startIdx;
      
      while(i < entries.length) {
        const entry = entries[i];
        const level = entry.level || 1;
        
        // ÌòÑÏû¨ Î†àÎ≤®Ïù¥ Î∂ÄÎ™®Î≥¥Îã§ ÏûëÍ±∞ÎÇò Í∞ôÏúºÎ©¥ ÏÉÅÏúÑÎ°ú ÎèåÏïÑÍ∞ê
        if(level <= parentLevel) {
          break;
        }
        
        let relTarget = entry.content;
        if(relTarget.startsWith(navDir)) relTarget = relTarget.slice(navDir.length);
        
        const indent = '      '.repeat(level);
        html += `${indent}<li>\n`;
        html += `${indent}  <a href="${escHtml(relTarget)}">${escHtml(entry.label)}</a>\n`;
        
        // Îã§Ïùå Ìï≠Î™©Ïù¥ ÌïòÏúÑ Î†àÎ≤®Ïù∏ÏßÄ ÌôïÏù∏
        if(i + 1 < entries.length && (entries[i + 1].level || 1) > level) {
          html += `${indent}  <ol>\n`;
          const childResult = buildNestedOl(entries, i + 1, level);
          html += childResult.content;
          html += `${indent}  </ol>\n`;
          i = childResult.nextIdx - 1;
        }
        
        html += `${indent}</li>\n`;
        i++;
      }
      
      return { content: html, nextIdx: i };
    }
    
    const result = buildNestedOl(tocEntries, 0, 0);
    const newOl = `<ol>\n${result.content}    </ol>`;
    
    // Find and replace ol
    const lower = original.toLowerCase();
    let olStart = lower.indexOf('<ol');
    if(olStart === -1) return;
    
    let depth = 0, olEnd = -1, i = olStart;
    while(i < original.length) {
      if(lower.startsWith('<ol', i)) { depth++; i += 3; }
      else if(lower.startsWith('</ol>', i)) {
        depth--;
        if(depth === 0) { olEnd = i + 5; break; }
        i += 5;
      }
      else { i++; }
    }
    if(olEnd === -1) return;
    
    files[tocFilePath] = original.slice(0, olStart) + newOl + original.slice(olEnd);
  }

  // ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ
  function getExt(path) {
    const parts = path.split('.');
    return parts.length > 1 ? parts[parts.length-1] : '';
  }

  function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function formatBytes(b) {
    if(b < 1024) return b + ' B';
    if(b < 1024*1024) return (b/1024).toFixed(1) + ' KB';
    return (b/(1024*1024)).toFixed(2) + ' MB';
  }

  function formatTimestamp(d) {
    if(!d) return '';
    const pad = n => String(n).padStart(2, '0');
    return `${String(d.getFullYear()).slice(2)}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function naturalSort(a, b) {
    return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
  }

  function updateStatus() {
    statusFile.textContent = activeTab || '‚Äî';
    statusType.textContent = activeTab ? (fileTypes[activeTab] || '‚Äî').toUpperCase() : '‚Äî';
    statusModified.textContent = modifiedFiles.size ? `${modifiedFiles.size}Í∞ú ÏàòÏ†ïÎê®` : '';
    statusModified.className = modifiedFiles.size ? 'modified' : '';
    
    if(activeTab && fileTimestamps[activeTab]) {
      statusTimestamp.textContent = formatTimestamp(fileTimestamps[activeTab]);
    } else {
      statusTimestamp.textContent = '‚Äî';
    }
    
    if(activeTab && files[activeTab]) {
      const d = files[activeTab];
      statusSize.textContent = formatBytes(d instanceof Uint8Array ? d.byteLength : new Blob([d]).size);
    } else {
      statusSize.textContent = '‚Äî';
    }
  }

  // ‚îÄ‚îÄ‚îÄ Replace All in Files ‚îÄ‚îÄ‚îÄ
  function replaceAllInFiles() {
    const searchText = document.getElementById('searchInput').value;
    const replaceText = document.getElementById('replaceInput').value;
    
    if (!searchText) {
      alert('Ï∞æÏùÑ ÌÖçÏä§Ìä∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî');
      return;
    }
    
    const caseSensitive = document.getElementById('caseSensitive').checked;
    const htmlOnly = document.getElementById('htmlOnly').checked;
    
    if (!confirm(`"${searchText}"Î•º "${replaceText}"Î°ú Î™®Îëê Î∞îÍæ∏ÏãúÍ≤†ÏäµÎãàÍπå?`)) {
      return;
    }
    
    let totalCount = 0;
    let fileCount = 0;
    
    Object.keys(files).forEach(path => {
      if (htmlOnly && !['.html', '.xhtml', '.htm'].some(ext => path.toLowerCase().endsWith(ext))) {
        return;
      }
      
      let content = files[path];
      let count = 0;
      
      if (caseSensitive) {
        const parts = content.split(searchText);
        count = parts.length - 1;
        if (count > 0) {
          files[path] = parts.join(replaceText);
        }
      } else {
        const escapedText = searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(escapedText, 'gi');
        const newContent = content.replace(regex, () => {
          count++;
          return replaceText;
        });
        if (count > 0) {
          files[path] = newContent;
        }
      }
      
      if (count > 0) {
        totalCount += count;
        fileCount++;
        
        // modifiedFilesÏóê Ï∂îÍ∞Ä
        modifiedFiles.add(path);
      }
    });
    
    if (totalCount > 0) {
      alert(`${fileCount}Í∞ú ÌååÏùºÏóêÏÑú ${totalCount}Í∞ú Ìï≠Î™©ÏùÑ Î∞îÍø®ÏäµÎãàÎã§`);
      
      // ÌòÑÏû¨ Ïó¥Î¶∞ ÌååÏùº ÏÉàÎ°úÍ≥†Ïπ®
      if (currPath && files[currPath]) {
        const textarea = document.getElementById('codeEditor');
        if (textarea) {
          textarea.value = files[currPath];
        }
      }
      
      // ÌååÏùº Î™©Î°ùÍ≥º ÌÉ≠ ÏÉàÎ°úÍ≥†Ïπ®
      renderFileTree();
      renderTabs();
      updateStatus();
      
      // Í≤ÄÏÉâ Îã§Ïãú Ïã§Ìñâ
      performSearch();
    } else {
      alert(`"${searchText}"Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§`);
    }
  }

  // Ctrl+FÎ°ú Í≤ÄÏÉâ Î™®Îã¨ Ïó¥Í∏∞
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'f') {
      e.preventDefault();
      document.getElementById('searchModal').classList.add('active');
      document.getElementById('searchInput').focus();
    }
  });

</script>
</body>
</html>
